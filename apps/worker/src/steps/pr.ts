import { createPR, findPRs, updatePR, type PRInfo, remoteBranchExists, push } from "@sebastian-code/vcs";
import { getRepoMode } from "@sebastian-code/core";
import type { Task } from "@sebastian-code/core";

export interface CreatePROptions {
  repoPath: string; // リポジトリパスを追加
  branchName: string;
  task: Task;
  baseBranch?: string;
  changedFiles: string[];
  stats: { additions: number; deletions: number };
  verificationResults: Array<{ command: string; success: boolean }>;
}

export interface CreatePRResult {
  success: boolean;
  pr?: PRInfo;
  isUpdate?: boolean;
  error?: string;
}

// PR本文を生成
function generatePRBody(options: CreatePROptions): string {
  const { task, changedFiles, stats, verificationResults } = options;

  const lines: string[] = [
    "## Summary",
    "",
    task.goal,
    "",
  ];

  // タスク情報
  lines.push(
    "## Task Details",
    "",
    `- **Task ID**: \`${task.id}\``,
    `- **Risk Level**: ${task.riskLevel}`,
    `- **Timebox**: ${task.timeboxMinutes} minutes`,
    ""
  );

  // 変更統計
  lines.push(
    "## Changes",
    "",
    `**${changedFiles.length}** files changed, **${stats.additions}** insertions(+), **${stats.deletions}** deletions(-)`,
    ""
  );

  // 変更ファイル一覧
  if (changedFiles.length > 0) {
    lines.push("<details>", "<summary>Changed files</summary>", "");
    for (const file of changedFiles) {
      lines.push(`- \`${file}\``);
    }
    lines.push("", "</details>", "");
  }

  // 検証結果
  lines.push("## Verification", "");
  for (const result of verificationResults) {
    const icon = result.success ? "✅" : "❌";
    lines.push(`${icon} \`${result.command}\``);
  }
  lines.push("");

  // 自動生成ラベル
  lines.push(
    "---",
    "",
    "_This PR was automatically generated by sebastian-code._",
    "",
    `Labels: \`agent\`, \`${task.riskLevel}-risk\``
  );

  return lines.join("\n");
}

// PRを作成または更新
export async function createTaskPR(
  options: CreatePROptions
): Promise<CreatePRResult> {
  const repoMode = getRepoMode();
  if (repoMode === "local") {
    console.log("Local mode: skipping PR creation");
    return {
      success: true,
      isUpdate: false,
    };
  }
  const { repoPath, branchName, task, baseBranch = "main" } = options;

  // ベースブランチがリモートに存在するか確認
  const baseExists = await remoteBranchExists(repoPath, baseBranch);
  
  if (!baseExists) {
    console.log(`Base branch ${baseBranch} does not exist on remote. Pushing directly to ${baseBranch}...`);
    // ベースブランチが存在しない場合（空のリポジトリなど）、直接ベースブランチとしてプッシュする
    const pushResult = await push(repoPath, `${branchName}:${baseBranch}`, true);
    
    if (!pushResult.success) {
      return {
        success: false,
        error: `Failed to push directly to non-existent base branch ${baseBranch}: ${pushResult.stderr}`,
      };
    }

    console.log(`Successfully pushed directly to ${baseBranch}. No PR needed.`);
    return {
      success: true,
      isUpdate: false,
    };
  }

  console.log("Checking for existing PR...");

  const title = `[sebastian-code] ${task.title}`;
  const body = generatePRBody(options);

  // リスクレベルに応じたラベル
  const labels = ["agent", "autogen", `${task.riskLevel}-risk`];

  try {
    // 既存のPRを探す（同じブランチからのPR）
    const existingPRs = await findPRs({
      head: branchName,
      base: baseBranch,
      state: "open",
    });

    if (existingPRs.length > 0 && existingPRs[0]) {
      const existingPR = existingPRs[0];
      console.log(`Updating existing PR #${existingPR.number}...`);

      const pr = await updatePR(existingPR.number, {
        title,
        body,
        labels,
      });

      return {
        success: true,
        pr,
        isUpdate: true,
      };
    }

    console.log("Creating new PR...");
    const pr = await createPR({
      title,
      body,
      head: branchName,
      base: baseBranch,
      labels,
      draft: task.riskLevel === "high", // 高リスクはdraftで作成
    });

    console.log(`PR created: ${pr.url}`);

    return {
      success: true,
      pr,
      isUpdate: false,
    };
  } catch (error) {
    const message = error instanceof Error ? error.message : String(error);
    console.error("Failed to create/update PR:", message);

    return {
      success: false,
      error: message,
    };
  }
}
