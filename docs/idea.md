# idea.md

sebastian-code を「要件 → 実装 → 検証 → マージ → デプロイ → 監視 → 次サイクル」まで、人間介入なしで回し続けるためのアイデアメモ。

## ゴールと前提

- ゴール: UI/コードを含むプロダクトを継続的に改善しつつ、品質を落とさず無限に回す。
- 前提: Planner/Worker/Judge/Cycle Manager の役割分離は維持し、実行は OpenCode を利用する。

## 「完成」の自動判定（最終ゲート）

タスク単位の `commands` や PR 単位の CI green は「必要条件」だが「十分条件」ではない。
プロダクトとしての完成は、主要導線と受け入れ条件を機械的に満たしているかで判定する。

- Playwright E2E（UI操作含む）
  - 主要ページのスモーク（起動、ログイン不要導線、CRUD、エラー表示の健全性）
  - クリティカル導線の回帰（例: 作成→一覧→詳細→削除）
  - trace / screenshot / video をアーティファクトとして保存
- API スモーク
  - /health や重要エンドポイントの疎通・基本整合性
  - スキーマ破壊や互換性破壊の検知（可能なら OpenAPI を生成して差分チェック）
- フロント健全性
  - 重大なコンソールエラー、白画面、重要 UI の欠損を検知

## triager（失敗分類・再計画）について

Cycle Manager は「サイクル制御・掃除・異常検知・再計画トリガ」が主で、失敗の原因分類と次手決定は弱くなりやすい。
triager は失敗/停滞を「次のタスク」に落とし直して、無限運用の詰まりをほどく役。

- 入力: task/run/pr/events（request_changes/blocked/failed、CIログ要約、OpenCode stderr、実行時間、flake率など）
- 出力: 次アクション
  - 自動再試行（flake/一時エラー）
  - 修正タスク（同一PR更新 or 修正PR）
  - タスク分割（大きすぎる/衝突多い）
  - 要件差し戻し（Requirement Interview に質問生成）
  - 一時停止/隔離（コスト暴騰、危険変更）

## docser（ドキュメント自動更新）

コード進行とドキュメント更新は競合しやすいので分離する。

- 変更差分から doc 更新が必要か判定
  - 公開 API 変更、env 追加、運用フロー変更、危険操作の追加
- docs PR を別途作る（コードPRと同梱する運用も選べるが、原則は追従PR）
- `docs/task.md` の進捗表は機械集計で更新（実装/未実装の乖離を抑える）

## tester（テスト専用エージェント）

実装とテストを分けることで、テストの厚みと安定性（flake対処）を上げる。

- Vitest
  - unit: ドメイン・ロジック
  - integration: DB/HTTP を含むが外部依存はモック or テストコンテナ
- Playwright
  - E2E（UI操作含む）の安定実行（待機戦略、seed、リトライ、隔離）
  - 成果物（trace/video/screenshot）を保存して Judge/triager へ渡す
- 変更差分から実行範囲を推定
  - unit のみ / integration 追加 / E2E 追加 を自動で選ぶ（速度と品質の両立）

## deployer（デプロイ専用エージェント）

無限運用で「動く」を担保するには、環境へ反映して検証するサイクルが必要。

- main マージ後に staging 自動デプロイ
- staging の E2E/スモーク/監視が OK なら本番候補
- 本番は段階的（canary → 100%）+ 自動ロールバック条件を持つ

## observer（監視・異常検知専用エージェント）

テストが通っても本番で壊れることはあるため、運用メトリクスで自動停止/復旧する。

- エラー率/レイテンシ/主要導線の失敗率/KPI を監視
- 異常時はデプロイ停止・ロールバック・原因タスク生成

## 実行隔離（sandbox）の一貫性

無限運用では「プロセス経路」と「Docker経路」が混在すると、制約が抜けて事故が起きやすい。

- OpenCode 実行・検証コマンド・テストは、常にサンドボックス経由に統一する
- 渡す環境変数は Allowlist を維持し、成果物/ログのみを外に出す

## PR停滞をゼロにする（request_changes の自己修正ループ）

Judge が request_changes を出したら、そこで止まらず次の実行に繋げる。

- 失敗理由を構造化してタスクに戻す（CIログ要約、ポリシー違反、LLM指摘）
- 同一ブランチ/同一PRの更新方針を決める（重複PRを増やさない）
- 修正回数上限を持ち、超えたら分割/要件質問へ落とす

## 要件対話（Requirement Interview）

要件ファイルを人が書く前提を弱め、曖昧さを対話で解消してから Planner に渡す。

- 収集したい情報
  - 受け入れ条件（機械判定可能な形式）
  - 対象範囲（In/Out）
  - 制約（技術、パフォーマンス、セキュリティ）
  - データ/画面/導線（UI要件）
- 会話ログを永続化し、確定した requirement をバージョン管理する

