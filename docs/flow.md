# 動作フロー

---

## 目的

要件定義からタスク生成、実装、検証、判定、停止までの一連の流れを整理する。

---

## フロー全体

1. 要件定義を用意する（`docs/requirement.md` など）
2. Plannerが要件を読み、タスクを生成してDBに保存する
3. Dispatcherがタスクを取得し、依存関係と優先度を整理する
4. DispatcherがLeaseを発行し、Workerを起動する
5. Workerが対象リポジトリを準備し、実装・検証を行う
6. Testerが必要なテストを追加し、実行結果を整理する
7. JudgeがCI/ポリシー/LLMレビューをもとに採否を決定する
8. Cycle Managerが状態を整理し、再計画または停止を判断する

---

## フロー詳細

### 1. 要件定義

- 要件は人間が記述し、曖昧さを残さない
- 受け入れ条件は機械的に判定できる形にする

### 2. Planner

- 要件を読み、30〜90分単位のタスクに分割する
- 依存関係と変更許可パスを明示する
- 生成したタスクを `tasks` テーブルに保存する

### 3. Dispatcher

- `queued` 状態のタスクを取得する
- 依存関係を満たすタスクのみ実行対象にする
- Leaseを発行して並列安全性を確保する

### 4. Worker

- 作業用ブランチを作成し、実装を行う
- 変更を検証し、成功条件を満たすまで自己修正を試みる
- 成果物（PR、ログ、差分）を記録する

### 5. Tester

- テスト追加と実行を担当する
- 失敗時は原因を分類し、次のタスク生成に利用する

### 6. Judge

- CI結果とポリシー違反の有無を確認する
- リスクが高い場合は人間レビューへエスカレーションする
- 採否を `runs` と `artifacts` に記録する

### 7. Cycle Manager

- 一定の時間/件数/失敗率に応じてサイクルを区切る
- すべてのWorker完了後に再計画を実行する

---

## 停止条件

- すべてのタスクが完了し、新しい要件差分が存在しない
- リスクが高く自動化が危険と判定された
- 失敗率やコストが閾値を超えた

---

最終更新: 2026/2/3
